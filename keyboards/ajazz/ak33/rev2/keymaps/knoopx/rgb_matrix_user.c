#include QMK_KEYBOARD_H

#include "rgb_matrix_user.h"

const uint8_t PROGMEM rgb_matrix_led_map[][DRIVER_LED_TOTAL][4] = {
   { {238,255,255}, {0,255,0}, {0,255,0}, {0,255,0}, {0,255,0}, {0,255,0}, {0,255,0}, {0,255,0}, {0,255,0}, {0,255,0}, {0,255,0}, {0,255,0}, {0,255,0}, {0,255,0}, {11,255,255}, {0,255,0}, {136,255,255}, {136,255,255}, {136,255,255}, {136,255,255}, {136,255,255}, {136,255,255}, {136,255,255}, {136,255,255}, {136,255,255}, {136,255,255}, {136,255,255}, {136,255,255}, {238,255,255}, {0,255,0}, {0,255,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {136,255,255}, {136,255,255}, {0,255,0}, {0,255,0}, {0,255,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {136,255,255}, {136,255,255}, {238,255,255}, {0,255,0}, {0,255,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {136,255,255}, {136,255,255}, {0,255,0}, {34,255,255}, {0,255,0}, {238,255,255}, {238,255,255}, {238,255,255}, {0,0,0}, {11,255,255}, {238,255,255}, {34,255,255}, {34,255,255}, {34,255,255} },
   { {0,0,0}, {11,255,255}, {11,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {238,255,255}, {136,255,255}, {136,255,255}, {136,255,255}, {136,255,255}, {136,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {136,255,255}, {136,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {136,255,255}, {136,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {136,255,255}, {136,255,255}, {0,0,0}, {34,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {34,255,255}, {34,255,255}, {34,255,255} },
   { {0,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {238,255,255}, {0,0,0}, {0,0,0}, {57,255,255}, {57,255,255}, {57,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {34,255,255}, {34,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {34,255,255}, {91,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {23,255,255}, {91,255,255}, {23,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0} },
   { {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {238,255,255}, {34,255,255}, {238,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {193,255,255}, {193,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {34,255,255}, {34,255,255}, {34,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {79,255,255}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {0,0,0}, {193,255,255}, {79,255,255}, {193,255,255} }
};

uint8_t flag(int layer, uint8_t row, uint8_t col) {
  uint8_t index = g_led_config.matrix_co[row][col];

  if (index < 0 || index >= DRIVER_LED_TOTAL) {
    return LED_FLAG_NONE;
  }

  // transparent keys
  keypos_t keypos = {col, row};
  if (keymap_key_to_keycode(layer, keypos) == KC_TRNS) {
    return LED_FLAG_NONE;
  }

  // custom colors
  // {0,   0,   0} TRNS
  // {0, 255,   0} OFF
  // {_,   _, 255} RGB
  HSV hsv = RGB_LED_MAP_COLOR(layer, index);
  if (hsv.v == 255 || (hsv.v == 0 && hsv.s == 255 && hsv.v == 0)) {
    return LED_FLAG_CUSTOM;
  }

  return LED_FLAG_KEYLIGHT;
}

void rgb_matrix_indicators_advanced_user(uint8_t led_min, uint8_t led_max) {
  if (rgb_matrix_config.flags != LED_FLAG_ALL) {
    uint8_t layer = get_highest_layer(layer_state);
    for (uint8_t row = 0; row < MATRIX_ROWS; ++row) {
      for (uint8_t col = 0; col < MATRIX_COLS; ++col) {
        uint8_t index = g_led_config.matrix_co[row][col];

        if (index < led_min || led_max >= DRIVER_LED_TOTAL) {
          continue;
        }

        keypos_t keypos = {col, row};

        if (g_led_config.flags[index] == LED_FLAG_NONE) {
          rgb_matrix_set_color(index, RGB_OFF);
          continue;
        }

        // caps lock indicator
        if (row == 3 && col == 0) {
          // schedule update on next tick
          if (host_keyboard_led_state().caps_lock) {
            g_led_config.flags[index] = LED_FLAG_INDICATOR;
          } else {
            g_led_config.flags[index] =
                keymap_key_to_keycode(layer, keypos) == KC_TRNS
                    ? LED_FLAG_NONE
                    : flag(layer, row, col);
          }
        }

        if (g_led_config.flags[index] == LED_FLAG_INDICATOR) {
          rgb_matrix_set_color(index, RGB_CAPSLOCK);
          continue;
        }

        if (g_led_config.flags[index] == LED_FLAG_CUSTOM) {
          HSV hsv = RGB_LED_MAP_COLOR(layer, index);
          if (hsv.v != 0) {
            hsv.v = rgb_matrix_config.hsv.v;
          }
          RGB rgb = hsv_to_rgb(hsv);
          rgb_matrix_set_color(index, rgb.r, rgb.g, rgb.b);
          continue;
        }
      }
    }
  }
}

void layer_state_update(int layer) {
  for (uint8_t row = 0; row < MATRIX_ROWS; ++row) {
    for (uint8_t col = 0; col < MATRIX_COLS; ++col) {
      uint8_t index = g_led_config.matrix_co[row][col];
      g_led_config.flags[index] = flag(layer, row, col);
    }
  }
}

layer_state_t layer_state_set_user(layer_state_t state) {
  layer_state_update(get_highest_layer(state));
  return state;
}

void keyboard_post_init_user(void) { rgb_matrix_set_flags(LED_FLAG_KEYLIGHT); }
